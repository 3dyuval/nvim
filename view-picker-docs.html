<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Snacks.nvim Picker Context Menu System</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px; 
            margin: 0 auto; 
            padding: 20px;
            line-height: 1.6;
            background: #1a1a1a;
            color: #e0e0e0;
        }
        h1, h2, h3 { color: #4fc3f7; }
        code { 
            background: #2d2d2d; 
            padding: 2px 4px; 
            border-radius: 3px;
            color: #f8f8f2;
        }
        pre { 
            background: #2d2d2d; 
            padding: 15px; 
            border-radius: 5px;
            overflow-x: auto;
        }
        .mermaid {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        ul, ol { padding-left: 20px; }
        li { margin: 5px 0; }
    </style>
</head>
<body>
    <h1>Snacks.nvim Picker Context Menu System</h1>

    <h2>Overview</h2>
    <p>This document describes the data flow and architecture of the context menu system for Snacks.nvim pickers, activated by pressing "b" in any picker.</p>

    <h2>Data Flow Diagram</h2>
    <div class="mermaid">
flowchart TD
    A[User presses 'b' in Snacks picker] --> B[show_context_menu function]
    B --> C[validate_picker]
    C --> D{Picker valid?}
    D -->|No| E[Show error notification]
    D -->|Yes| F[detect_context function]
    
    F --> G[Check explorer actions]
    F --> H[Check git_status patterns]
    F --> I[Check buffer properties]
    F --> J[Check file properties]
    
    G --> K{Has explorer_* actions?}
    H --> L{Has git status patterns?}
    I --> M{Has bufnr property?}
    J --> N{Has file property?}
    
    K -->|Yes| O[Context: explorer]
    L -->|Yes| P[Context: git_status]
    M -->|Yes| Q[Context: buffers]
    N -->|Yes| R[Context: files]
    
    K -->|No| H
    L -->|No| I
    M -->|No| J
    N -->|No| S[Context: unknown]
    
    O --> T[get_items for explorer]
    P --> U[get_items for git_status]
    Q --> V[get_items for buffers]
    R --> W[get_items for files]
    S --> X[Fallback item retrieval]
    
    T --> Y[Try picker:selected]
    T --> Z[Try picker:current]
    T --> AA[Try picker.list.selected]
    
    U --> Y
    V --> Y
    W --> Y
    X --> Y
    
    Y --> BB{Items found?}
    Z --> BB
    AA --> BB
    
    BB -->|No| CC[Show 'No actions available' warning]
    BB -->|Yes| DD[get_actions function]
    
    DD --> EE{Context type?}
    EE -->|explorer/files| FF[File/directory actions]
    EE -->|git_status| GG[Git-specific actions]
    EE -->|buffers| HH[Buffer actions]
    
    FF --> II{Single item?}
    II -->|Yes| JJ{Is directory?}
    II -->|No| KK[Multiple items actions]
    
    JJ -->|Yes| LL[Directory actions]
    JJ -->|No| MM[File actions]
    
    LL --> NN[Add git actions if in repo]
    MM --> NN
    KK --> NN
    GG --> NN
    HH --> NN
    
    NN --> OO[Create vim.ui.select menu]
    OO --> PP[User selects action]
    PP --> QQ[Execute selected action]
    
    QQ --> RR{Action type?}
    RR -->|File operation| SS[Rename/Delete/Copy]
    RR -->|Navigation| TT[Open/Split/Tab]
    RR -->|Git operation| UU[Stage/Unstage/Restore]
    RR -->|Buffer operation| VV[Save/Delete/Wipe]
    RR -->|Utility| WW[Save patterns/Search]
    
    SS --> XX[Refresh picker if needed]
    TT --> YY[Close picker]
    UU --> XX
    VV --> XX
    WW --> XX
    </div>

    <h2>Context Detection Strategy</h2>
    <h3>Primary Detection (Capability-based)</h3>
    <p>Since <code>picker.opts.source</code> is unreliable (often <code>nil</code>), we use capability-based detection:</p>

    <div class="mermaid">
flowchart LR
    A[Picker Object] --> B{Has explorer_* actions?}
    B -->|Yes| C[Explorer Context]
    B -->|No| D{Current item has git status?}
    D -->|Yes| E[Git Status Context]
    D -->|No| F{Current item has bufnr?}
    F -->|Yes| G[Buffers Context]
    F -->|No| H{Current item has file property?}
    H -->|Yes| I[Files Context]
    H -->|No| J[Unknown Context]
    </div>

    <h3>Item Retrieval Hierarchy</h3>
    <p>For each context, items are retrieved using this fallback chain:</p>

    <div class="mermaid">
flowchart TD
    A[Start item retrieval] --> B[Try picker:selected]
    B --> C{Has items?}
    C -->|Yes| D[Return selected items]
    C -->|No| E[Try picker:current]
    E --> F{Has current?}
    F -->|Yes| G[Return current as array]
    F -->|No| H[Try picker.list.selected]
    H --> I{Has list items?}
    I -->|Yes| J[Return list items]
    I -->|No| K[Return empty array]
    </div>

    <h2>Action Categories</h2>

    <h3>Explorer/Files Context</h3>
    <ul>
        <li><strong>Single File</strong>: Open, split, rename, delete, copy path, save patterns</li>
        <li><strong>Single Directory</strong>: Open, explore, terminal, rename, delete, new file/dir</li>
        <li><strong>Multiple Items</strong>: Delete all, copy paths, open all files, save patterns</li>
        <li><strong>Git Actions</strong>: Add, restore (if in git repo)</li>
    </ul>

    <h3>Git Status Context</h3>
    <ul>
        <li><strong>Stage/Unstage</strong>: Toggle staging status based on current state</li>
        <li><strong>Restore</strong>: Restore files to HEAD state</li>
        <li><strong>Diff</strong>: Show git diff in split</li>
        <li><strong>Save Patterns</strong>: Run formatting on changed files</li>
    </ul>

    <h3>Buffers Context</h3>
    <ul>
        <li><strong>Delete</strong>: Close buffer (with confirmation)</li>
        <li><strong>Wipe</strong>: Force close buffer</li>
        <li><strong>Save</strong>: Write buffer to disk</li>
        <li><strong>Save Patterns</strong>: Run formatting on buffer content</li>
    </ul>

    <h2>Key Technical Solutions</h2>

    <h3>Problem: Source Field Unreliable</h3>
    <ul>
        <li><strong>Issue</strong>: <code>picker.opts.source</code> often returns <code>nil</code></li>
        <li><strong>Solution</strong>: Detect context by examining available actions and item properties</li>
    </ul>

    <h3>Problem: Empty Item Lists</h3>
    <ul>
        <li><strong>Issue</strong>: <code>picker:selected()</code> returns <code>{}</code> instead of <code>nil</code> when no selection</li>
        <li><strong>Solution</strong>: Check <code>#selected > 0</code> and implement fallback chain</li>
    </ul>

    <h3>Problem: Different Picker Behaviors</h3>
    <ul>
        <li><strong>Issue</strong>: Different pickers expose items differently</li>
        <li><strong>Solution</strong>: Unified <code>get_items</code> function with multiple fallback strategies</li>
    </ul>

    <h2>Files Modified</h2>
    <ul>
        <li><code>lua/utils/picker-extensions.lua</code> - Main implementation</li>
        <li><code>lua/plugins/snacks.lua</code> - Key binding configuration (<code>["b"]</code> mapping)</li>
    </ul>

    <h2>Usage</h2>
    <p>Press <code>b</code> in any Snacks.nvim picker to open the context menu with appropriate actions for the current context and selected/current items.</p>

    <script>
        mermaid.initialize({ 
            startOnLoad: true,
            theme: 'dark',
            themeVariables: {
                primaryColor: '#4fc3f7',
                primaryTextColor: '#ffffff',
                primaryBorderColor: '#4fc3f7',
                lineColor: '#ffffff',
                secondaryColor: '#2d2d2d',
                tertiaryColor: '#1a1a1a'
            }
        });
    </script>
</body>
</html>